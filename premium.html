<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="color-scheme" content="dark light"/>
  <title>å®Œå…¨ç‰ˆãƒ¬ãƒãƒ¼ãƒˆ | 16BodyPersonalities</title>

  <!-- Favicon 404 å›é¿ -->
  <link rel="icon" href="data:,">

  <!-- ãƒ•ã‚©ãƒ³ãƒˆï¼†CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="./styles.css?v=2"/>
  <link rel="stylesheet" href="./premium.css?v=1"/>
</head>

<body data-page="premium">
  <div class="wrap" id="app">
    <header class="site">
      <div class="brand">16Body<b>Personalities</b> <span class="pill">Premium</span></div>
      <div class="tools">
        <button class="btn" id="btn-save-img">ç”»åƒä¿å­˜</button>
        <button class="btn" id="btn-save-pdf">PDFä¿å­˜</button>
        <button class="btn" id="btn-send-mail">è‡ªåˆ†ã«å†é€</button>
      </div>
    </header>

    <!-- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å…ˆ -->
    <div id="premium-root" class="grid" style="margin-top:10px">
      <div class="card">
        <h2>èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
        <p class="muted">å°‚ç”¨ãƒªãƒ³ã‚¯ï¼ˆtokenï¼‰ã‹ã‚‰å®Œå…¨ç‰ˆãƒ¬ãƒãƒ¼ãƒˆã‚’å¾©å…ƒã—ã¦ã„ã¾ã™ã€‚</p>
      </div>
    </div>

    <div class="footer">
      <span>Â© 2025 16BodyPersonalities Project</span>
      <span class="muted">This report is personalized for you.</span>
    </div>
  </div>

  <!-- ç”»åƒ/PDF å‡ºåŠ›ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ======= è¨­å®šï¼ˆGASã®ç¨¼åƒURLï¼‰ ======= -->
  <script>
    // ã‚ãªãŸãŒå…±æœ‰ã—ãŸæœ€æ–°ã®URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxVTRr8ju0FPCi7rDiY6lXI4c3oGUOGhmEv8zttNf8yS_1sO01ssg5yWfvgPilcxzvj/exec";
  </script>

  <!-- ======= å…±é€šãƒ‡ãƒ¼ã‚¿ï¼ˆTYPE_META / BODY_TIPS / BRAND_BY_TYPE / TYPE_NICK ç­‰ï¼‰ ======= -->
  <!-- â€» types.js ã‚’ä½¿ã£ã¦ã„ã‚‹ãªã‚‰ meta.js ã‚’ types.js ã«å¤‰æ›´ã—ã¦OK -->
  <script src="./meta.js"></script>

  <!-- ======= å…±é€šã®çµæœãƒ“ãƒ¥ãƒ¼ï¼ˆrenderResult / _renderResultCore ãªã©ï¼‰ ======= -->
  <!-- ãƒ‘ã‚¹ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Ÿä½“ã«åˆã‚ã›ã¦ã€‚ã“ã“ã§ã¯ãƒ«ãƒ¼ãƒˆç›´ä¸‹ç‰ˆ -->
  <script src="./resultView.js"></script>

  <!-- ======= JSONP & ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======= -->
  <script>
    const $ = (sel, root=document) => root.querySelector(sel);

    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = '__jp' + Math.random().toString(36).slice(2);
        const s  = document.createElement('script');
        const q  = (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        window[cb] = (data)=>{ resolve(data); cleanup(); };
        s.onerror  = ()=>{ reject(new Error('JSONP failed')); cleanup(); };
        s.src = url + q;
        s.async = true;
        document.head.appendChild(s);
        function cleanup(){ delete window[cb]; s.remove(); }
      });
    }

    // åŒæ„ï¼ˆå¿…è¦ãªã‚‰æœ¬ä½“ã¨æƒãˆã‚‹ï¼‰
    const getConsent = () => localStorage.getItem('km_consent') || 'yes';

    // åˆæœŸ stateï¼ˆanswers ã¯å¾Œã§å¾©å…ƒæ³¨å…¥ï¼‰
    function makeInitialState(){
      const initLen = (window.QUESTIONS?.frame?.length || 12);
      const init = () => Array.from({length: initLen}, ()=>3);
      return {
        step: 4,
        answers: {
          frame:   init(),
          surface: init(),
          balance: init(),
          line:    init(),
        }
      };
    }
    let state = makeInitialState();

    // ç”»åƒä¿å­˜
    async function saveAsImage(){
      const root = document.getElementById('premium-root') || document.getElementById('app') || document.body;
      // â˜…ã“ã“ã‚’è¿½åŠ ï¼ˆæç”»å…ˆã‚’ premium-root ã«å›ºå®šï¼‰
window.app = root;
root.innerHTML = '';  // "èª­ã¿è¾¼ã¿ä¸­â€¦" ã‚’æ¶ˆã™
      const canvas = await html2canvas(root, {useCORS:true, scale:2});
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = '16BP-premium.png';
      a.click();
    }

    // PDFä¿å­˜ï¼ˆA4ç¸¦ã§1ãƒšãƒ¼ã‚¸ã«ç¸®å°ï¼‰
    async function saveAsPDF(){
      const { jsPDF } = window.jspdf;
      const root = document.getElementById('premium-root') || document.getElementById('app') || document.body;
      const canvas = await html2canvas(root, {useCORS:true, scale:2});
      const imgData = canvas.toDataURL('image/png');

      const pdf = new jsPDF({ unit:'mm', format:'a4', orientation:'p' });
      const pageW = 210, pageH = 297;
      const imgW = pageW - 20; // 10mm margin
      const imgH = canvas.height * imgW / canvas.width;
      pdf.addImage(imgData, 'PNG', 10, 10, imgW, Math.min(imgH, pageH-20));
      pdf.save('16BP-premium.pdf');
    }

    // ãƒ¡ãƒ¼ãƒ«å†é€ï¼ˆGAS: sendMail=1 & email & codeï¼‰
    async function resendMail(){
      const email = prompt('å®Œå…¨ç‰ˆURLã‚’å†é€ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ğŸ“©');
      if (!email) return;

      let code = '';
      try {
        code = (typeof buildCode === 'function') ? buildCode().code : '';
      } catch(e){ /* noop */ }

      try{
        const res = await jsonp(`${GAS_URL}?sendMail=1&email=${encodeURIComponent(email)}&code=${encodeURIComponent(code||'')}`);
        if (!res?.ok) throw new Error(res?.error || 'é€ä¿¡å¤±æ•—');
        alert('é€ä¿¡ã—ã¾ã—ãŸï¼è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚');
      }catch(e){
        alert('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š' + (e?.message || e));
      }
    }

    // èµ·å‹•ï¼štokenâ†’GASã‹ã‚‰å¾©å…ƒâ†’resultViewã§æç”»
    async function boot(){
      try{
        const root = document.getElementById('premium-root') || document.getElementById('app') || document.body;

        const params = new URLSearchParams(location.search);
        const token  = params.get('token');
        if (!token){
          root.innerHTML = `
            <div class="card">
              <h2>ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2>
              <p class="muted">URLã® <code>?token=...</code> ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
            </div>`;
          return;
        }

        // GAS ã‹ã‚‰å¾©å…ƒï¼ˆ/exec?report=1&token=...ï¼‰
        const r = await jsonp(`${GAS_URL}?report=1&token=${encodeURIComponent(token)}`);
        if (!r?.ok || !r?.data){
          root.innerHTML = `
            <div class="card">
              <h2>å¾©å…ƒã‚¨ãƒ©ãƒ¼</h2>
              <p class="muted">${(r && r.error) ? r.error : 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'}</p>
            </div>`;
          return;
        }

        // answers æ³¨å…¥ â†’ æç”»
        state = makeInitialState();
        if (r.data.answers) state.answers = r.data.answers;
root.innerHTML = '';
        // çµæœãƒ“ãƒ¥ãƒ¼ï¼ˆresultView.js ç”±æ¥ï¼‰
        if (typeof renderResult === 'function') {
          renderResult();
        } else if (typeof _renderResultCore === 'function') {
          _renderResultCore();
        } else {
          root.innerHTML = `
            <div class="card">
              <h2>çµæœãƒ“ãƒ¥ãƒ¼ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</h2>
              <p class="muted">resultView.js ã®ãƒ‘ã‚¹ã‚„èª­ã¿è¾¼ã¿é †ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
            </div>`;
          return;
        }

        // ãƒœã‚¿ãƒ³ç´ä»˜ã‘
        const btnImg = document.getElementById('btn-save-img');
        const btnPdf = document.getElementById('btn-save-pdf');
        const btnMail= document.getElementById('btn-send-mail');
        btnImg && btnImg.addEventListener('click', saveAsImage, {passive:true});
        btnPdf && btnPdf.addEventListener('click', saveAsPDF,   {passive:true});
        btnMail&& btnMail.addEventListener('click', resendMail, {passive:true});

      }catch(e){
        const root = document.getElementById('premium-root') || document.getElementById('app') || document.body;
        console.error(e);
        root.innerHTML = `
          <div class="card">
            <h2>ã‚¨ãƒ©ãƒ¼</h2>
            <p class="muted">${e?.message || e}</p>
          </div>`;
      }
    }

    // èµ·å‹•
    boot();
  </script>
</body>
</html>